<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Georgia Tech Football AI Assistant</title>

<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --gt-navy:#003057; --gt-gold:#B3A369; --gt-gold-2:#d1b674;
    --glass:rgba(255,255,255,.07); --ring:rgba(179,163,105,.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--gt-gold);
    background:
      radial-gradient(1200px 700px at 10% -10%, rgba(255,255,255,.06), transparent 60%),
      radial-gradient(900px 600px at 110% -10%, rgba(255,255,255,.06), transparent 60%),
      repeating-linear-gradient(to bottom, rgba(255,255,255,.06) 0 2px, transparent 2px 70px),
      var(--gt-navy);
    font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    line-height:1.45;
  }
  .wrap{max-width:1200px; margin:0 auto; padding:56px 18px}
  header{display:flex; align-items:center; justify-content:center; gap:14px; margin-bottom:12px}
  .badge{width:56px;height:56px;border-radius:50%;background:linear-gradient(145deg,var(--gt-gold),#e6d39a);
    display:grid;place-items:center;color:var(--gt-navy);box-shadow:0 12px 30px rgba(0,0,0,.25), inset 0 2px 8px rgba(255,255,255,.35);font-size:27px;font-weight:800}
  h1{margin:0;font-family:'Oswald',sans-serif;font-weight:700;letter-spacing:.5px;
    font-size:clamp(2.2rem,4.4vw,3.4rem);text-transform:uppercase;text-shadow:0 2px 0 rgba(0,0,0,.35)}
  .sub{max-width:920px;margin:10px auto 26px;color:#eee3bf;opacity:.95;font-size:1.05rem;text-align:center}
  .btn{appearance:none;border:0;cursor:pointer;font-weight:800;padding:14px 22px;border-radius:14px;letter-spacing:.3px;
    color:var(--gt-navy);background:linear-gradient(180deg,var(--gt-gold),var(--gt-gold-2));
    box-shadow:0 10px 22px rgba(0,0,0,.25),0 0 0 0px var(--ring);transition:transform .15s ease,box-shadow .2s ease,filter .2s ease}
  .btn:hover{transform:translateY(-2px);filter:brightness(1.05);box-shadow:0 14px 28px rgba(0,0,0,.35),0 0 0 6px var(--ring)}
  .section{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.09);border-radius:22px;padding:22px;box-shadow:0 18px 38px rgba(0,0,0,.25);backdrop-filter:blur(8px);margin:18px 0}
  .section h2{font-family:'Oswald',sans-serif;margin:0 0 12px;font-weight:700;letter-spacing:.4px;text-transform:uppercase}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
  @media (max-width:980px){.grid-2,.grid-3{grid-template-columns:1fr}}
  .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px}
  .stat{font-size:1.6rem;font-weight:800;color:#ffeaa4}

  /* Wider chat modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
  .modal[open]{display:flex}
  .modal-card{width:min(92vw,1200px);height:min(88vh,900px);border-radius:20px;overflow:hidden;background:#0c1f38;
    border:1px solid rgba(255,255,255,.12);box-shadow:0 30px 80px rgba(0,0,0,.6);animation:pop .18s ease-out}
  @keyframes pop{from{transform:scale(.98);opacity:0}to{transform:scale(1);opacity:1}}
  .modal-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;
    background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border-bottom:1px solid rgba(255,255,255,.08)}
  .modal-title{font-family:'Oswald',sans-serif;text-transform:uppercase;letter-spacing:.4px;display:flex;align-items:center;gap:10px}
  .close{border:0;background:transparent;color:#f5eeda;font-size:26px;cursor:pointer;line-height:1;padding:6px 10px;border-radius:10px}
  .close:hover{background:rgba(255,255,255,.08)}
  .frame-wrap{height:calc(100% - 58px)}
  iframe.assistant{width:100%;height:100%;border:0;display:block;background:#fff}
</style>
</head>
<body>

<main class="wrap">
  <header>
    <div class="badge">üèà</div>
    <h1>Georgia Tech Football AI Assistant</h1>
  </header>

  <p class="sub">
    Now reading: <b>GT Offense vs All Opponents</b> (single CSV). Select an opponent to see scouting and a quick prediction.
  </p>

  <div class="section">
    <h2>‚è±Ô∏è Countdown to Next Game</h2>
    <div id="countdown" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
      <div class="card"><div class="stat" id="cd-days">‚Äì</div>Days</div>
      <div class="card"><div class="stat" id="cd-hours">‚Äì</div>Hours</div>
      <div class="card"><div class="stat" id="cd-mins">‚Äì</div>Mins</div>
      <div class="card"><div class="stat" id="cd-secs">‚Äì</div>Secs</div>
    </div>
    <p class="sub" id="nextGameLabel" style="margin:10px 0 0; font-size:.96rem; opacity:.85;"></p>
  </div>

  <div class="section">
    <h2>üß† Opponent Scouting & üîÆ Prediction</h2>
    <div class="grid-2">
      <div class="card">
        <h3 style="margin-top:0">Opponent Scouting Summary</h3>
        <label for="opponentSelect">Opponent:</label>
        <select id="opponentSelect" class="btn" style="padding:10px;font-weight:700;border-radius:10px;margin-left:10px"></select>
        <div id="scoutOut" style="margin-top:14px; font-size:1rem; line-height:1.5"><em>Loading CSV‚Ä¶</em></div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Game Prediction (toy)</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          <label>GT vs</label>
          <select id="predictOpponent" class="btn" style="padding:10px;font-weight:700;border-radius:10px"></select>
          <button id="runPrediction" class="btn">Simulate</button>
        </div>
        <div id="predictionOut" style="margin-top:14px; font-size:1.05rem"><em>Pick an opponent and simulate.</em></div>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>üìä Dashboard from This CSV</h2>
    <div class="grid-2">
      <div class="card">
        <h3 style="margin-top:0">GT vs Opp ‚Äî Rushing (Yds/Play)</h3>
        <canvas id="rushChart" height="190"></canvas>
      </div>
      <div class="card">
        <h3 style="margin-top:0">GT vs Opp ‚Äî Passing (Yds/Play)</h3>
        <canvas id="passChart" height="190"></canvas>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>‚≠ê Spotlight (by Opponent)</h2>
    <div id="spotlights" class="grid-3"></div>
  </div>

  <div style="display:flex;gap:12px;justify-content:center;margin-top:10px">
    <button id="openAssistant" class="btn">Launch Assistant</button>
    <a class="btn" href="gt_offense_vs_all_opp_lbs_breakdown.csv" download>Download Current CSV</a>
  </div>
</main>

<!-- Wider modal chat -->
<dialog id="assistantModal" class="modal" aria-label="Chat">
  <div class="modal-card" role="document">
    <div class="modal-head">
      <div class="modal-title">üèà GT Football Assistant</div>
      <button class="close" id="closeAssistant" aria-label="Close chat">&times;</button>
    </div>
    <div class="frame-wrap">
      <!-- Replace with your real chat URL -->
      <iframe
        class="assistant"
        src="https://www.chatbase.co/chatbot-iframe/agAmCcP2bEhWDDzGaNRqP"
        allow="clipboard-read; clipboard-write; microphone; camera;"
        sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
        loading="lazy"
        title="Embedded chat"
      ></iframe>
    </div>
  </div>
</dialog>

<script>
/* ===== CONFIG (edit nextGame if you want) ===== */
const CONFIG = {
  nextGame: {
    label: "vs TBD ‚Äî Bobby Dodd Stadium",
    kickoffISO: "2025-11-01T15:30:00"
  },
  csvPath: "gt_offense_vs_all_opp_lbs_breakdown.csv" // single CSV at repo root
};

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
function numify(v){
  if (v == null) return 0;
  // strip commas and units like "yds"
  const cleaned = String(v).replace(/[, ]/g,"").replace(/[^0-9.\-]/g,"");
  const n = parseFloat(cleaned);
  return isNaN(n) ? 0 : n;
}
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const headers = lines.shift().split(",").map(h=>h.trim());
  return {
    headers,
    rows: lines.map(line=>{
      const cells = line.split(","); // simple split; fine for no embedded commas
      const o = {};
      headers.forEach((h,i)=> o[h] = (cells[i]??"").trim());
      return o;
    })
  };
}
function findHeader(headers, candidates){
  const lower = headers.map(h=>h.toLowerCase());
  for (const cand of candidates){
    const idx = lower.findIndex(h => h.includes(cand));
    if (idx !== -1) return headers[idx];
  }
  return null;
}

/* ===== Modal controls ===== */
const modal = $('#assistantModal');
$('#openAssistant').addEventListener('click', ()=> modal.showModal());
$('#closeAssistant').addEventListener('click', ()=> modal.close());
modal.addEventListener('click', (e)=>{
  const r = modal.querySelector('.modal-card').getBoundingClientRect();
  if (e.clientX < r.left || e.clientX > r.right || e.clientY < r.top || e.clientY > r.bottom) modal.close();
});
document.addEventListener('keydown', e=>{ if(e.key==='Escape' && modal.open) modal.close() });

/* ===== Countdown ===== */
(function(){
  const kick = new Date(CONFIG.nextGame.kickoffISO);
  $('#nextGameLabel').textContent = `${CONFIG.nextGame.label} ‚Äî ${kick.toLocaleString()}`;
  function tick(){
    const now = new Date(); let s = Math.max(0, Math.floor((kick - now)/1000));
    const d = Math.floor(s/86400); s -= d*86400;
    const h = Math.floor(s/3600); s -= h*3600;
    const m = Math.floor(s/60); const sec = s - m*60;
    $('#cd-days').textContent=d; $('#cd-hours').textContent=h; $('#cd-mins').textContent=m; $('#cd-secs').textContent=sec;
  }
  tick(); setInterval(tick, 1000);
})();

/* ===== Load the single CSV and wire features ===== */
let CSV = null;
let COLS = {}; // detected columns

(async function init(){
  try{
    const res = await fetch(CONFIG.csvPath, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    CSV = parseCSV(text);
    detectColumns();
    buildOpponentDropdowns();
    renderScout();
    renderPrediction();
    renderCharts();
    renderSpotlights();
  }catch(e){
    console.error(e);
    $('#scoutOut').innerHTML = `<span style="color:#ffdede">Failed to load CSV (${e.message}). Make sure the file is at the repo root and you're viewing via GitHub Pages (not file://).</span>`;
  }
})();

/* ===== Column detection (very forgiving) ===== */
function detectColumns(){
  const H = CSV.headers;
  COLS.opponent = findHeader(H, ["opponent","opp","defense_team","team"]);
  // rushing & passing per-play if present
  COLS.rushYPP = findHeader(H, ["rush_ypp","rushing_ypp","rush_ypc","rushing_ypc","rush_yards_per_play","rushing_yards_per_play"]);
  COLS.rushYds = findHeader(H, ["rush_yards","rushing_yards","rush_yds","rushing_yds","ry"]);
  COLS.rushAtt = findHeader(H, ["rush_att","rushing_att","carries","rush_attempts"]);
  COLS.passYPP = findHeader(H, ["pass_ypp","passing_ypp","pass_ypa","passing_ypa","pass_yards_per_play"]);
  COLS.passYds = findHeader(H, ["pass_yards","passing_yards","py","pass_yds","passing_yds"]);
  COLS.passAtt = findHeader(H, ["attempts","pass_att","passing_att","pass_attempts"]);
  COLS.ypp     = findHeader(H, ["yards_per_play","ypp","avg_yards"]);
  COLS.success = findHeader(H, ["success_rate","sr"]);
  COLS.epa     = findHeader(H, ["epa","off_epa","epa_per_play"]);
  COLS.td      = findHeader(H, ["td","tds","touchdowns","off_td"]);
}

/* ===== Opponent list ===== */
function getOpponents(){
  const col = COLS.opponent;
  if(!col) return [];
  const set = new Set(CSV.rows.map(r => r[col]).filter(Boolean));
  return Array.from(set).sort();
}
function buildOpponentDropdowns(){
  const opps = getOpponents();
  ["opponentSelect","predictOpponent"].forEach(id=>{
    const sel = document.getElementById(id);
    sel.innerHTML = "";
    const opt0 = document.createElement('option'); opt0.value=""; opt0.textContent="Select Opponent";
    sel.appendChild(opt0);
    opps.forEach(t => {
      const o = document.createElement('option'); o.value=t; o.textContent=t;
      sel.appendChild(o);
    });
    sel.addEventListener('change', ()=> {
      if(id==="opponentSelect") renderScout();
      else renderPrediction();
    });
  });
}

/* ===== Scouting summary from one row (or avg multiple rows) ===== */
function aggregateForOpponent(opp){
  const rows = CSV.rows.filter(r => r[COLS.opponent] === opp);
  const agg = (key) => rows.length ? rows.reduce((s,r)=> s + numify(r[key]), 0) / rows.length : 0;
  // Prefer per-play stats; compute fallback from yards/attempts
  let rushYPP = COLS.rushYPP ? agg(COLS.rushYPP) :
      (COLS.rushYds && COLS.rushAtt ? (rows.reduce((s,r)=>s+numify(r[COLS.rushYds]),0) /
                                        Math.max(1, rows.reduce((s,r)=>s+numify(r[COLS.rushAtt]),0))) : 0);
  let passYPP = COLS.passYPP ? agg(COLS.passYPP) :
      (COLS.passYds && COLS.passAtt ? (rows.reduce((s,r)=>s+numify(r[COLS.passYds]),0) /
                                        Math.max(1, rows.reduce((s,r)=>s+numify(r[COLS.passAtt]),0))) : 0);
  const ypp   = COLS.ypp ? agg(COLS.ypp) : (rushYPP && passYPP ? (0.4*rushYPP + 0.6*passYPP) : 0);
  const sr    = COLS.success ? agg(COLS.success) : 0;
  const epa   = COLS.epa ? agg(COLS.epa) : 0;
  const td    = COLS.td ? agg(COLS.td) : 0;
  return { rushYPP, passYPP, ypp, sr, epa, td };
}
function renderScout(){
  const opp = $('#opponentSelect').value;
  const out = $('#scoutOut');
  if(!opp){ out.innerHTML = `<em>Select an opponent to see a quick GT-offense summary versus them.</em>`; return; }
  const s = aggregateForOpponent(opp);
  const pct = v => isFinite(v) ? (v*100).toFixed(1)+"%" : "‚Äî";
  out.innerHTML = `
    <div class="grid-2">
      <div class="card"><div class="stat">${s.rushYPP.toFixed(2)}</div><div>Rush yards/play vs ${opp}</div></div>
      <div class="card"><div class="stat">${s.passYPP.toFixed(2)}</div><div>Pass yards/play vs ${opp}</div></div>
      <div class="card"><div class="stat">${s.ypp.toFixed(2)}</div><div>Total yards/play (est.)</div></div>
      <div class="card"><div class="stat">${COLS.success ? pct(s.sr) : "‚Äî"}</div><div>${COLS.success ? "Success rate" : "Success rate (n/a in CSV)"}</div></div>
    </div>
    <p style="margin-top:10px;opacity:.9">
      Tip: Ask the assistant for ‚Äútendencies vs ${opp} by down & distance‚Äù for narrative insights.
    </p>
  `;
}

/* ===== Prediction (toy): score = z-scored blend of ypp, success, epa ===== */
function predictionScore(opp){
  const s = aggregateForOpponent(opp);
  // Build vector of available metrics
  const metrics = [];
  if (s.ypp) metrics.push(s.ypp);
  if (s.sr)  metrics.push(s.sr*10); // scale up SR so magnitudes are comparable
  if (s.epa) metrics.push(s.epa*8); // scale EPA
  if (!metrics.length) metrics.push((s.passYPP||0)*0.6 + (s.rushYPP||0)*0.4);
  return metrics.reduce((a,b)=>a+b,0) / metrics.length;
}
function renderPrediction(){
  const opp = $('#predictOpponent').value;
  const out = $('#predictionOut');
  if(!opp){ out.innerHTML = `<em>Select opponent then press Simulate.</em>`; return; }

  // Build distribution across all opponents to normalize
  const opps = getOpponents();
  const scores = opps.map(o => predictionScore(o)).filter(v => isFinite(v));
  const mean = scores.reduce((a,b)=>a+b,0) / Math.max(1,scores.length);
  const std  = Math.sqrt(scores.reduce((s,v)=> s + Math.pow(v-mean,2),0) / Math.max(1,scores.length)) || 1;

  // z-score for selected opponent: higher GT offense vs this opp => higher win prob
  const z = (predictionScore(opp) - mean) / std;
  const prob = 1/(1+Math.exp(-z)); // logistic of z

  out.innerHTML = `
    <p>Estimated win probability (toy, offense-only vs <b>${opp}</b>):</p>
    <div class="stat">${(prob*100).toFixed(1)}%</div>
    <p style="opacity:.85">Uses GT offense metrics from this CSV (YPP/Success/EPA if present) normalized across opponents.</p>
  `;
}
$('#runPrediction').addEventListener('click', renderPrediction);

/* ===== Charts: top/bottom opponents by per-play yards ===== */
let rushChart, passChart;
function renderCharts(){
  const opps = getOpponents();
  const rows = opps.map(o => ({ o, s: aggregateForOpponent(o) }));
  const topRush = rows.slice().sort((a,b)=> (b.s.rushYPP||0)-(a.s.rushYPP||0)).slice(0,10);
  const topPass = rows.slice().sort((a,b)=> (b.s.passYPP||0)-(a.s.passYPP||0)).slice(0,10);

  const rctx = document.getElementById('rushChart').getContext('2d');
  const pctx = document.getElementById('passChart').getContext('2d');
  rushChart && rushChart.destroy(); passChart && passChart.destroy();

  rushChart = new Chart(rctx,{
    type:'bar',
    data:{ labels: topRush.map(x=>x.o), datasets:[{label:"Rush Yds/Play", data: topRush.map(x=>+(x.s.rushYPP||0).toFixed(2))}]},
    options:{ plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
  });
  passChart = new Chart(pctx,{
    type:'bar',
    data:{ labels: topPass.map(x=>x.o), datasets:[{label:"Pass Yds/Play", data: topPass.map(x=>+(x.s.passYPP||0).toFixed(2))}]},
    options:{ plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
  });
}

/* ===== Spotlights: show three notable opponents from this CSV ===== */
function renderSpotlights(){
  const host = $('#spotlights'); host.innerHTML = "";
  const opps = getOpponents();
  if(!opps.length){ host.innerHTML = `<div class="card">No opponents found in CSV.</div>`; return; }
  const picks = opps.sort(()=>Math.random()-0.5).slice(0,3);
  picks.forEach(o=>{
    const s = aggregateForOpponent(o);
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <div style="font-weight:800;font-size:1.1rem">${o}</div>
      <div class="stat" style="margin-top:6px">${s.ypp ? s.ypp.toFixed(2) : ((s.passYPP||0)*0.6+(s.rushYPP||0)*0.4).toFixed(2)}</div>
      <div style="opacity:.9">GT yards/play vs ${o}</div>
    `;
    host.appendChild(el);
  });
}
</script>
</body>
</html>
